# Hashicorp Vault

[Hashicorp Vault](#hashicorp-vault)
  - [Authentication & Configuration](#authentication--configuration)
  - [AWS Secret Engine](#aws-secret-engine)
  - [Key Value v2](#key-value-v2)
  - [Key Value v1](#key-value-v1)

## Authentication & Configuration

Vault adress can be specified with (by order of precedence):

- `VAULT_ADDR` environment variable
- `.novops.yml` config:
  ```yaml
  config:
    hashivault:
      address: http://localhost:8200
      # token: xxx # token can be set in config for testing
  
  environments: #...
  ```

Hashicorp Vault generate [tokens for authenticated entities](https://developer.hashicorp.com/vault/docs/concepts/auth#tokens). You can use any authentication method (`vault login`, web UI/API...) to get a valid token to be used by Novops.

Novops will load token in this order:

- `VAULT_TOKEN` environment variable
- `.novops.yml` config:
  ```yaml
  config:
    hashivault:
      address: http://localhost:8200
      # Path to a token file
      token_path: /run/secrets/vault-token
  ```
- Local file `~/.vault-token` ([generated by default with `vault login`](https://developer.hashicorp.com/vault/docs/commands#token-helper))

Generally, `VAULT_*` [environment variables available for `vault` CLI](https://developer.hashicorp.com/vault/docs/commands#environment-variables) will also work with Novops.

## AWS Secret Engine

[AWS Secret Engine](https://developer.hashicorp.com/vault/api-docs/secret/aws) to generate temporary credentials. Maps directly to [Generate Credentials API](https://developer.hashicorp.com/vault/api-docs/secret/aws#generate-credentials). Outputs environment variables `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY` & `AWS_SESSION_TOKEN` used by most [AWS SDKs and tools](https://docs.aws.amazon.com/sdkref/latest/guide/environment-variables.html):

```yaml
environments:
  test:
    hashivault:
      aws:
        mount: aws
        name: dev_role
        role_arn: arn:aws:iam::111122223333:role/dev_role
        role_session_name: dev-session
        ttl: 2h
```

## Key Value v2

Hashicorp Vault [Key Value Version 2](https://www.vaultproject.io/docs/secrets/kv/kv-v2) with variables and files:

```yaml
environment:
  dev:
    variables:
    - name: APP_PASSWORD
      value:
        hvault_kv2:
          mount: "secret"
          path: "myapp/dev/creds"
          key: "password"

    files:
    - name: SECRET_TOKEN
      dest: .token
      content:
        hvault_kv2:
          path: "myapp/dev/creds"
          key: "token"
```

## Key Value v1

Hashicorp Vault [Key Value Version 1](https://www.vaultproject.io/docs/secrets/kv/kv-v1) with variables and files:

```yaml
environments:
  dev:
    variables:
      - name: APP_PASSWORD
        value:
          hvault_kv1:
            path: app/dev
            key: password
            mount: kv1 # Override secret engine mount ('secret' by default)
    
    files:
      - variable: APP_TOKEN
        content:
          hvault_kv1:
            path: app/dev
            key: token
```
